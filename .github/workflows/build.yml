name: Build & Release Artifacts (multi-arch binaries + static assets)

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write
  actions: read
  checks: read

jobs:
  build_binaries:
    name: Build binary components (platform matrix)
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        platform: [linux/amd64]
        component:
          - name: awww
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup buildx
        uses: docker/setup-buildx-action@v3
        with:
          install: true

      - name: Build component for platform
        run: |
          set -euxo pipefail
          PLATFORM_TAG=$(echo "${{ matrix.platform }}" | tr '/' '-')
          DEST="${{ matrix.component.name }}-${PLATFORM_TAG}"
          mkdir -p "$DEST"

          CONTAINERFILE="${{ matrix.component.name }}/Containerfile"
          echo "Using build file: $CONTAINERFILE"
          docker buildx build \
            --platform "${{ matrix.platform }}" \
            --file "$CONTAINERFILE" \
            --target export \
            --output "type=local,dest=${DEST}" \
            "${{ matrix.component.name }}"

          echo "Contents of $DEST:"
          ls -l "$DEST"

          TARFILE="${DEST}.tar.gz"
          echo "Creating tarball: $TARFILE"
          tar -C "$DEST" -czf "$TARFILE" .
          echo "Tarball created:"
          ls -l "$TARFILE"

          # Export PLATFORM_TAG for subsequent steps
          echo "PLATFORM_TAG=${PLATFORM_TAG}" >> "$GITHUB_ENV"

      - name: Upload per-arch artifact
        uses: actions/upload-artifact@v4
        with:
          # Artifact name includes component + platform tag (slashes already replaced)
          name: ${{ matrix.component.name }}-${{ env.PLATFORM_TAG }}
          path: ${{ matrix.component.name }}-${{ env.PLATFORM_TAG }}.tar.gz
          if-no-files-found: error
          retention-days: 3

  build_static:
    name: Build static components (platform matrix)
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        platform: [linux/amd64]
        component:
          - name: wallpaper
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup buildx
        uses: docker/setup-buildx-action@v3
        with:
          install: true

      - name: Build component for platform
        run: |
          set -euxo pipefail
          mkdir -p "${{ matrix.component.name }}"

          CONTAINERFILE="${{ matrix.component.name }}/Containerfile"
          echo "Using build file: $CONTAINERFILE"
          docker buildx build \
            --platform "${{ matrix.platform }}" \
            --file "$CONTAINERFILE" \
            --target export \
            --output "type=local,dest=${{ matrix.component.name }}" \
            "${{ matrix.component.name }}"

          echo "Contents of ${{ matrix.component.name }}:"
          ls -l "${{ matrix.component.name }}"

          TARFILE="${{ matrix.component.name }}.tar.gz"
          echo "Creating tarball: $TARFILE"
          tar -C "${{ matrix.component.name }}" -czf "$TARFILE" .
          echo "Tarball created:"
          ls -l "$TARFILE"

      - name: Upload per-arch artifact
        uses: actions/upload-artifact@v4
        with:
          # Artifact name includes component + platform tag (slashes already replaced)
          name: ${{ matrix.component.name }}
          path: ${{ matrix.component.name }}.tar.gz
          if-no-files-found: error
          retention-days: 3

  release:
    name: Create latest release
    needs:
      - build_binaries
      - build_static
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (for tag manipulation)
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: "*"
          path: dist

      - name: Gather tarballs & checksums
        run: |
          set -euxo pipefail
          mkdir -p packages
          echo "Downloaded artifact directories:"
          ls -1 dist || true

          find dist -type f -name '*.tar.gz' -exec cp -v {} packages/ \;

          echo "Collected tarballs:"
          ls -l packages || true

          if [ -z "$(find packages -name '*.tar.gz' -type f | head -n1)" ]; then
            echo "No tarballs found to release." >&2
            find dist -maxdepth 3 -type f -print || true
            exit 1
          fi

          (cd packages && sha256sum *.tar.gz > SHA256SUMS.txt)
          echo "Checksums:"
          cat packages/SHA256SUMS.txt

          echo "Tarballs produced:"
          ls -l packages

          (cd packages && sha256sum *.tar.gz > SHA256SUMS.txt)
          echo "Checksums:"
          cat packages/SHA256SUMS.txt

          if [ -z "$(find packages -name '*.tar.gz' -type f | head -n1)" ]; then
            echo "No tarballs produced." >&2
            exit 1
          fi

      - name: Move latest tag to current commit
        run: |
          set -euxo pipefail
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git tag -f latest
          git push origin -f latest

      - name: Publish release (recreate)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euxo pipefail
          TAG=latest
          if gh release view "$TAG" >/dev/null 2>&1; then
            gh release delete "$TAG" -y
          fi
          NOTES="Automated build for '${TAG}' (commit $GITHUB_SHA). Tarballs were produced inside the component build stages."
          gh release create "$TAG" \
            --title "Latest build (${TAG})" \
            --notes "$NOTES" \
            packages/*.tar.gz packages/SHA256SUMS.txt

      - name: Output release URL
        run: |
          echo "Release: https://github.com/${{ github.repository }}/releases/tag/latest"
