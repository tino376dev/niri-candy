name: Build & Release Artifacts

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

permissions:
  contents: write
  actions: read
  checks: read

env:
  # Adjust if you want multi-arch later
  BUILD_PLATFORMS: linux/amd64

jobs:
  build:
    name: Build artifact matrix
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        component:
          - name: awww
            path: awww
            artifact_dir: awww_artifacts
            # files expected from export stage
            outputs: |
              awww
              awww-daemon
          - name: wallpaper
            path: wallpaper
            artifact_dir: wallpaper_artifacts
            outputs: |
              light.png
              dark.png
              light-blur.png
              dark-blur.png

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup buildx
        uses: docker/setup-buildx-action@v3
        with:
          install: true

      - name: Build
        run: |
          set -euxo pipefail
          COMPONENT_PATH="${{ matrix.component.path }}"
          PLATFORM_TAG=$(echo "${BUILD_PLATFORMS}" | tr '/,' '-')
          DEST="${{ matrix.component.artifact_dir }}/$PLATFORM_TAG"
          mkdir -p "$DEST"
          docker buildx build \
            --platform "${BUILD_PLATFORMS}" \
            --target export \
            --output "type=local,dest=${DEST}" \
            "${COMPONENT_PATH}"
          echo "Contents of $DEST:"
          ls -l "$DEST"

      - name: Upload
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.component.name }}
          path: ${{ matrix.component.artifact_dir }}/*
          if-no-files-found: error
          retention-days: 3

  release:
    name: Create release
    needs: [build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (for tag manipulation)
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: "*"
          path: dist

      - name: Move latest tag to current commit
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git tag -f latest
          git push origin -f latest

      - name: Publish release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG=latest
          gh release create "$TAG" \
            --title "Daily build $TAG" \
            --notes "Automated daily build for $TAG" \
            flat/*

      - name: Output release URL
        run: |
          echo "Release: https://github.com/${{ github.repository }}/releases/tag/latest"
